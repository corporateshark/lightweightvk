/*
 * LightweightVK
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

// Bilingual: GLSL (default) and Slang. Define the macro LVK_DEMO_WITH_SLANG to switch to Slang.

#include "VulkanApp.h"

// we are going to use raw Vulkan here to initialize VK_EXT_mesh_shader
#include <lvk/vulkan/VulkanUtils.h>

const char* codeSlang = R"(
struct Vertex {
  float3 position;
  float3 color;
  float flare;
};

struct PerFrame {
  float4x4 proj;
  float4x4 view;
  uint texture;
};

struct PushConstants {
  PerFrame* perFrame;
  Vertex* vb;
};

[[vk::push_constant]] PushConstants pc;

struct VertexOutput {
  float3 color : COLOR0;
  float2 uv    : TEXCOORD0;
};

static const float2 offs[4] = {
  float2(-1.0, -1.0),
  float2(+1.0, -1.0),
  float2(-1.0, +1.0),
  float2(+1.0, +1.0)
};

struct MeshOutput {
  float4 position : SV_Position;
  float3 color : COLOR0;
  float2 uv    : TEXCOORD0;
};

[shader("mesh")]
[numthreads(1, 1, 1)]
[outputtopology("triangle")]
void meshMain(
  uint3 groupID : SV_GroupID,
  out vertices MeshOutput verts[4],
  out indices uint3 triangles[2]
) {
  SetMeshOutputCounts(4, 2);
  
  float4x4 proj = pc.perFrame->proj;
  float4x4 view = pc.perFrame->view;
  Vertex v = pc.vb[groupID.x];
  float4 center = view * float4(v.position, 1.0);
  
  float2 size  = v.flare > 0.5 ? float2(0.08, 0.4) : float2(0.2, 0.2);
  float3 color = v.flare > 0.5 ? 0.5 * v.color : v.color;
  
  for (uint i = 0; i < 4; i++) {
    float4 offset = float4(size * offs[i], 0, 0);
    verts[i].position = proj * (center + offset);
    verts[i].color = color;
    verts[i].uv = (offs[i] + 1.0) * 0.5; // convert from [-1, 1] to [0, 1]
  }
  
  triangles[0] = uint3(0, 1, 2);
  triangles[1] = uint3(2, 1, 3);
}

[shader("fragment")]
float4 fragmentMain(VertexOutput input : VertexOutput) : SV_Target
{
  float alpha = textureBindless2D(pc.perFrame->texture, 0, input.uv).r;
  return float4(input.color, alpha);
}
)";

const char* codeMesh = R"(
layout(local_size_x = 1, local_size_y = 1, local_size_z = 1) in;
layout(triangles, max_vertices = 4, max_primitives = 2) out;

struct Vertex {
  float x, y, z;
  float r, g, b, flare;
};

layout(std430, buffer_reference) readonly buffer VertexBuffer {
  Vertex vertices[];
};

layout(std430, buffer_reference) readonly buffer PerFrame {
  mat4 proj;
  mat4 view;
  uint texture;
};

layout(push_constant) uniform constants {
  PerFrame perFrame;
  VertexBuffer vb;
} pc;

layout (location=0) out vec3 colors[4];
layout (location=1) out vec2 uvs[4];

const vec2 offs[4] = vec2[4](
  vec2(-1.0, -1.0),
  vec2(+1.0, -1.0),
  vec2(-1.0, +1.0),
  vec2(+1.0, +1.0)
);

void main() {
  SetMeshOutputsEXT(4, 2);

  mat4 proj = pc.perFrame.proj;
  mat4 view = pc.perFrame.view;
  Vertex v = pc.vb.vertices[gl_WorkGroupID.x];
  vec4 center = view * vec4(v.x, v.y, v.z, 1.0);

  vec2 size  = v.flare > 0.5 ? vec2(0.08, 0.4) : vec2(0.2, 0.2);
  vec3 color = v.flare > 0.5 ? 0.5 * vec3(v.r, v.g, v.b) : vec3(v.r, v.g, v.b);

  for (uint i = 0; i != 4; i++) {
    vec4 offset = vec4(size * offs[i], 0, 0);
    gl_MeshVerticesEXT[i].gl_Position = proj * (center + offset);
    colors[i] = color;    
    uvs[i] = (offs[i] + 1.0) * 0.5; // convert from [-1, 1] to [0, 1]
  }

  // two triangles forming a quad
  gl_MeshPrimitivesEXT[0].gl_CullPrimitiveEXT = false;
  gl_MeshPrimitivesEXT[1].gl_CullPrimitiveEXT = false;
  gl_PrimitiveTriangleIndicesEXT[0] = uvec3(0, 1, 2);
  gl_PrimitiveTriangleIndicesEXT[1] = uvec3(2, 1, 3);
}
)";

const char* codeFS = R"(
layout (location=0) in vec3 color;
layout (location=1) in vec2 uv;
layout (location=0) out vec4 out_FragColor;

layout(std430, buffer_reference) readonly buffer PerFrame {
  mat4 proj;
  mat4 view;
  uint texture;
};

layout(push_constant) uniform constants {
	PerFrame perFrame;
} pc;

void main() {
  float alpha = textureBindless2D(pc.perFrame.texture, 0, uv).r;
  out_FragColor = vec4(color, alpha);
};
)";

static const uint8_t g_Image[4096] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x02, 0x01, 0x02, 0x03, 0x03, 0x04, 0x03, 0x03, 0x04, 0x03, 0x05, 0x04,
    0x04, 0x05, 0x04, 0x06, 0x06, 0x05, 0x06, 0x07, 0x05, 0x05, 0x06, 0x04, 0x06, 0x03, 0x03, 0x05, 0x04, 0x04, 0x03, 0x04, 0x02, 0x01,
    0x02, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x04, 0x03, 0x05, 0x06, 0x05, 0x07, 0x07, 0x07, 0x06,
    0x06, 0x07, 0x08, 0x08, 0x08, 0x07, 0x08, 0x07, 0x06, 0x05, 0x05, 0x05, 0x06, 0x05, 0x06, 0x05, 0x05, 0x04, 0x03, 0x02, 0x02, 0x01,
    0x02, 0x02, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x01, 0x01, 0x01, 0x03, 0x02, 0x02, 0x03, 0x04, 0x04, 0x04, 0x06, 0x06, 0x06, 0x05, 0x06, 0x09, 0x06, 0x07, 0x08, 0x08, 0x07,
    0x07, 0x0a, 0x09, 0x0a, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x06, 0x06, 0x07, 0x06, 0x04, 0x05, 0x04, 0x04, 0x03, 0x02, 0x02, 0x02,
    0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01,
    0x01, 0x01, 0x01, 0x02, 0x03, 0x03, 0x04, 0x03, 0x05, 0x06, 0x06, 0x09, 0x08, 0x06, 0x09, 0x08, 0x0a, 0x08, 0x08, 0x09, 0x0b, 0x0c,
    0x0c, 0x09, 0x0a, 0x0a, 0x09, 0x08, 0x09, 0x08, 0x08, 0x06, 0x09, 0x07, 0x07, 0x06, 0x06, 0x04, 0x03, 0x04, 0x03, 0x02, 0x02, 0x01,
    0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01,
    0x02, 0x03, 0x04, 0x05, 0x05, 0x05, 0x08, 0x07, 0x09, 0x06, 0x0a, 0x09, 0x08, 0x09, 0x0a, 0x0d, 0x0a, 0x0d, 0x0e, 0x0c, 0x0e, 0x0a,
    0x0c, 0x0c, 0x09, 0x0a, 0x0a, 0x0c, 0x0a, 0x08, 0x0a, 0x09, 0x07, 0x07, 0x07, 0x06, 0x04, 0x04, 0x04, 0x03, 0x04, 0x03, 0x01, 0x01,
    0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x02, 0x03, 0x03, 0x05, 0x04,
    0x06, 0x04, 0x05, 0x08, 0x06, 0x08, 0x09, 0x0a, 0x0a, 0x0a, 0x0b, 0x0c, 0x0d, 0x0c, 0x0d, 0x0c, 0x0d, 0x0d, 0x0c, 0x0d, 0x0c, 0x0e,
    0x0b, 0x0e, 0x0e, 0x0c, 0x0c, 0x0c, 0x08, 0x08, 0x08, 0x09, 0x07, 0x07, 0x07, 0x05, 0x05, 0x03, 0x04, 0x03, 0x03, 0x03, 0x02, 0x02,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x01, 0x03, 0x02, 0x05, 0x05, 0x04, 0x07, 0x05,
    0x08, 0x08, 0x08, 0x0b, 0x0b, 0x0c, 0x0c, 0x0b, 0x0e, 0x10, 0x10, 0x0d, 0x11, 0x11, 0x10, 0x0e, 0x0f, 0x0e, 0x11, 0x0e, 0x0f, 0x0d,
    0x0f, 0x0e, 0x0c, 0x0b, 0x0b, 0x0c, 0x09, 0x08, 0x07, 0x08, 0x06, 0x06, 0x04, 0x04, 0x04, 0x03, 0x03, 0x03, 0x01, 0x00, 0x01, 0x01,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x03, 0x03, 0x06, 0x04, 0x06, 0x06, 0x07, 0x09, 0x07,
    0x09, 0x0d, 0x0c, 0x0e, 0x0d, 0x0f, 0x0f, 0x11, 0x11, 0x15, 0x15, 0x13, 0x15, 0x14, 0x16, 0x14, 0x16, 0x15, 0x14, 0x12, 0x13, 0x11,
    0x0f, 0x10, 0x0f, 0x0b, 0x0b, 0x0d, 0x0a, 0x0a, 0x08, 0x07, 0x07, 0x07, 0x05, 0x04, 0x04, 0x03, 0x03, 0x01, 0x01, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x03, 0x02, 0x03, 0x03, 0x06, 0x07, 0x07, 0x06, 0x09, 0x09, 0x09, 0x0c, 0x0a, 0x0c,
    0x0f, 0x0e, 0x0f, 0x14, 0x18, 0x18, 0x16, 0x18, 0x19, 0x1a, 0x16, 0x18, 0x16, 0x18, 0x1a, 0x18, 0x18, 0x16, 0x15, 0x15, 0x13, 0x10,
    0x0e, 0x0d, 0x0c, 0x0b, 0x0c, 0x0a, 0x0a, 0x07, 0x07, 0x06, 0x07, 0x06, 0x03, 0x03, 0x02, 0x03, 0x01, 0x01, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x01, 0x00, 0x01, 0x02, 0x04, 0x04, 0x03, 0x05, 0x08, 0x06, 0x06, 0x08, 0x09, 0x0a, 0x0c, 0x0c, 0x10, 0x12, 0x12,
    0x13, 0x19, 0x16, 0x19, 0x19, 0x1d, 0x1c, 0x1d, 0x1a, 0x1d, 0x1e, 0x1a, 0x1e, 0x1d, 0x1c, 0x1d, 0x18, 0x16, 0x1a, 0x18, 0x18, 0x10,
    0x11, 0x0d, 0x0e, 0x0d, 0x0c, 0x0b, 0x07, 0x07, 0x07, 0x05, 0x06, 0x05, 0x04, 0x03, 0x03, 0x02, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x02, 0x02, 0x02, 0x03, 0x04, 0x05, 0x07, 0x08, 0x07, 0x09, 0x0b, 0x0a, 0x0b, 0x0b, 0x0e, 0x10, 0x13, 0x14, 0x14, 0x18, 0x1b,
    0x19, 0x1b, 0x1c, 0x20, 0x1c, 0x1c, 0x1d, 0x20, 0x1e, 0x1c, 0x1f, 0x1d, 0x21, 0x1d, 0x1a, 0x1a, 0x18, 0x1b, 0x18, 0x16, 0x18, 0x0e,
    0x10, 0x0d, 0x0d, 0x0b, 0x08, 0x0a, 0x09, 0x06, 0x06, 0x04, 0x03, 0x03, 0x03, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
    0x03, 0x03, 0x02, 0x03, 0x04, 0x04, 0x08, 0x0a, 0x0a, 0x09, 0x0a, 0x0b, 0x0e, 0x11, 0x13, 0x14, 0x19, 0x19, 0x1b, 0x1a, 0x1d, 0x1d,
    0x1d, 0x21, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23, 0x23, 0x1f, 0x24, 0x21, 0x22, 0x21, 0x1c, 0x1c, 0x19, 0x19, 0x15, 0x15, 0x15, 0x0f,
    0x10, 0x0c, 0x0d, 0x0b, 0x09, 0x06, 0x06, 0x05, 0x05, 0x03, 0x03, 0x03, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04,
    0x05, 0x05, 0x05, 0x07, 0x07, 0x08, 0x09, 0x0d, 0x0c, 0x10, 0x0e, 0x15, 0x15, 0x19, 0x16, 0x19, 0x1c, 0x20, 0x1e, 0x21, 0x25, 0x23,
    0x27, 0x28, 0x28, 0x27, 0x29, 0x25, 0x26, 0x26, 0x29, 0x24, 0x20, 0x24, 0x22, 0x1d, 0x1e, 0x1a, 0x1c, 0x1a, 0x16, 0x13, 0x0f, 0x0e,
    0x0a, 0x0c, 0x0a, 0x08, 0x06, 0x08, 0x05, 0x05, 0x04, 0x02, 0x03, 0x02, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x05, 0x06, 0x04,
    0x06, 0x07, 0x07, 0x09, 0x0a, 0x0e, 0x0c, 0x0e, 0x12, 0x15, 0x19, 0x1a, 0x1c, 0x1c, 0x1f, 0x20, 0x22, 0x25, 0x29, 0x27, 0x2b, 0x28,
    0x28, 0x29, 0x2b, 0x28, 0x2b, 0x28, 0x28, 0x2b, 0x23, 0x24, 0x21, 0x1f, 0x1d, 0x1f, 0x1d, 0x1a, 0x19, 0x16, 0x16, 0x10, 0x0c, 0x0b,
    0x0d, 0x0a, 0x07, 0x08, 0x05, 0x05, 0x06, 0x03, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x02, 0x03, 0x03, 0x03, 0x04, 0x07, 0x06, 0x09,
    0x0b, 0x0c, 0x0e, 0x0e, 0x0f, 0x13, 0x19, 0x1a, 0x1c, 0x1e, 0x1e, 0x22, 0x22, 0x26, 0x28, 0x28, 0x2c, 0x2d, 0x2e, 0x2b, 0x2d, 0x2f,
    0x2f, 0x33, 0x2f, 0x31, 0x2e, 0x29, 0x28, 0x29, 0x25, 0x28, 0x22, 0x1f, 0x1e, 0x1c, 0x19, 0x16, 0x15, 0x12, 0x0d, 0x0e, 0x0b, 0x0b,
    0x0b, 0x06, 0x06, 0x06, 0x06, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x03, 0x02, 0x04, 0x04, 0x07, 0x07, 0x09, 0x0a, 0x0a, 0x0c,
    0x0b, 0x0e, 0x13, 0x16, 0x18, 0x1a, 0x20, 0x1e, 0x23, 0x21, 0x25, 0x2b, 0x2c, 0x2e, 0x31, 0x2f, 0x30, 0x32, 0x34, 0x31, 0x35, 0x38,
    0x34, 0x30, 0x30, 0x32, 0x2f, 0x2e, 0x28, 0x2b, 0x25, 0x21, 0x1f, 0x21, 0x1f, 0x19, 0x1a, 0x18, 0x15, 0x10, 0x0c, 0x0d, 0x0c, 0x08,
    0x09, 0x06, 0x06, 0x04, 0x03, 0x02, 0x00, 0x00, 0x00, 0x00, 0x01, 0x04, 0x03, 0x05, 0x06, 0x07, 0x08, 0x0b, 0x0a, 0x0e, 0x0d, 0x13,
    0x15, 0x19, 0x1c, 0x1c, 0x1f, 0x22, 0x22, 0x29, 0x29, 0x2d, 0x30, 0x33, 0x33, 0x37, 0x34, 0x3a, 0x35, 0x3a, 0x37, 0x42, 0x35, 0x37,
    0x39, 0x34, 0x34, 0x32, 0x2e, 0x2b, 0x28, 0x25, 0x27, 0x1f, 0x22, 0x1e, 0x1b, 0x18, 0x18, 0x12, 0x0e, 0x0e, 0x0a, 0x0a, 0x07, 0x07,
    0x05, 0x04, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x04, 0x05, 0x0a, 0x09, 0x0a, 0x0d, 0x0c, 0x0f, 0x14, 0x19, 0x19,
    0x1c, 0x1d, 0x21, 0x24, 0x28, 0x29, 0x2f, 0x30, 0x31, 0x35, 0x34, 0x38, 0x3a, 0x3c, 0x3e, 0x3e, 0x3d, 0x52, 0x3e, 0x3e, 0x38, 0x36,
    0x3a, 0x33, 0x30, 0x2f, 0x2f, 0x29, 0x26, 0x22, 0x24, 0x21, 0x1a, 0x18, 0x14, 0x16, 0x10, 0x0e, 0x0c, 0x0a, 0x0b, 0x06, 0x05, 0x07,
    0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x02, 0x04, 0x05, 0x08, 0x07, 0x0a, 0x09, 0x0c, 0x0d, 0x10, 0x12, 0x18, 0x1a, 0x1a, 0x21, 0x23,
    0x28, 0x27, 0x2e, 0x2c, 0x31, 0x35, 0x36, 0x39, 0x3e, 0x3d, 0x43, 0x44, 0x46, 0x44, 0x46, 0x55, 0x45, 0x46, 0x40, 0x3e, 0x3d, 0x36,
    0x37, 0x30, 0x31, 0x2c, 0x29, 0x25, 0x23, 0x23, 0x1d, 0x1d, 0x1a, 0x16, 0x12, 0x0f, 0x0b, 0x0d, 0x09, 0x09, 0x06, 0x07, 0x04, 0x05,
    0x00, 0x00, 0x00, 0x00, 0x02, 0x06, 0x05, 0x06, 0x07, 0x0b, 0x0b, 0x0c, 0x0f, 0x14, 0x16, 0x19, 0x1a, 0x1c, 0x21, 0x22, 0x27, 0x2d,
    0x2e, 0x2f, 0x33, 0x34, 0x3c, 0x41, 0x43, 0x44, 0x48, 0x4b, 0x4d, 0x4b, 0x4e, 0x57, 0x4e, 0x49, 0x44, 0x44, 0x40, 0x40, 0x3a, 0x39,
    0x33, 0x2e, 0x2e, 0x2c, 0x25, 0x26, 0x21, 0x1f, 0x19, 0x19, 0x13, 0x11, 0x0d, 0x0c, 0x0a, 0x0a, 0x08, 0x07, 0x05, 0x04, 0x00, 0x00,
    0x00, 0x00, 0x04, 0x05, 0x04, 0x05, 0x0a, 0x08, 0x0c, 0x0c, 0x0d, 0x12, 0x18, 0x19, 0x1f, 0x20, 0x25, 0x28, 0x28, 0x2e, 0x33, 0x34,
    0x36, 0x3e, 0x42, 0x46, 0x47, 0x49, 0x4f, 0x50, 0x51, 0x53, 0x57, 0x57, 0x56, 0x52, 0x4e, 0x4d, 0x4a, 0x43, 0x40, 0x3b, 0x38, 0x32,
    0x32, 0x2a, 0x29, 0x22, 0x24, 0x1f, 0x1e, 0x16, 0x19, 0x14, 0x10, 0x0c, 0x0b, 0x0b, 0x07, 0x06, 0x05, 0x04, 0x00, 0x00, 0x00, 0x00,
    0x04, 0x06, 0x06, 0x07, 0x0a, 0x09, 0x0c, 0x0e, 0x12, 0x16, 0x1a, 0x1b, 0x1d, 0x24, 0x22, 0x2b, 0x29, 0x2d, 0x33, 0x36, 0x3b, 0x3f,
    0x49, 0x4c, 0x4e, 0x52, 0x55, 0x57, 0x59, 0x56, 0x5c, 0x56, 0x5d, 0x55, 0x52, 0x4d, 0x4d, 0x48, 0x43, 0x41, 0x3c, 0x34, 0x34, 0x30,
    0x2b, 0x26, 0x22, 0x23, 0x1c, 0x1c, 0x16, 0x14, 0x0e, 0x0e, 0x0a, 0x0a, 0x08, 0x06, 0x06, 0x04, 0x00, 0x00, 0x00, 0x00, 0x05, 0x06,
    0x08, 0x0a, 0x08, 0x0b, 0x0b, 0x0d, 0x16, 0x16, 0x1c, 0x1a, 0x20, 0x21, 0x28, 0x29, 0x2c, 0x31, 0x36, 0x3c, 0x41, 0x45, 0x4b, 0x4e,
    0x50, 0x56, 0x58, 0x61, 0x64, 0x66, 0x69, 0x61, 0x5f, 0x5d, 0x59, 0x55, 0x52, 0x4f, 0x48, 0x43, 0x3b, 0x3e, 0x35, 0x32, 0x2f, 0x2c,
    0x23, 0x25, 0x1c, 0x19, 0x18, 0x13, 0x0e, 0x0f, 0x0b, 0x09, 0x0a, 0x08, 0x05, 0x04, 0x00, 0x00, 0x00, 0x00, 0x04, 0x05, 0x07, 0x09,
    0x0b, 0x0d, 0x0c, 0x11, 0x14, 0x16, 0x19, 0x20, 0x1d, 0x27, 0x2b, 0x2a, 0x32, 0x35, 0x3a, 0x3f, 0x44, 0x4b, 0x4d, 0x55, 0x58, 0x5e,
    0x65, 0x6b, 0x70, 0x71, 0x7d, 0x71, 0x70, 0x6c, 0x5e, 0x59, 0x58, 0x51, 0x4b, 0x47, 0x41, 0x3d, 0x34, 0x33, 0x32, 0x29, 0x26, 0x25,
    0x1f, 0x1d, 0x1c, 0x18, 0x12, 0x11, 0x0b, 0x0b, 0x0a, 0x07, 0x05, 0x06, 0x00, 0x00, 0x00, 0x00, 0x03, 0x06, 0x05, 0x09, 0x09, 0x0b,
    0x0c, 0x12, 0x14, 0x16, 0x19, 0x21, 0x23, 0x25, 0x29, 0x2f, 0x31, 0x34, 0x3a, 0x44, 0x49, 0x4d, 0x53, 0x56, 0x61, 0x63, 0x70, 0x79,
    0x86, 0x83, 0x8f, 0x87, 0x7d, 0x77, 0x6d, 0x64, 0x5d, 0x58, 0x54, 0x4a, 0x46, 0x41, 0x39, 0x33, 0x30, 0x31, 0x2c, 0x25, 0x24, 0x20,
    0x19, 0x19, 0x15, 0x0d, 0x0b, 0x0c, 0x0b, 0x0a, 0x05, 0x06, 0x00, 0x00, 0x00, 0x00, 0x05, 0x06, 0x07, 0x0b, 0x0b, 0x0c, 0x0d, 0x11,
    0x16, 0x19, 0x1c, 0x1c, 0x22, 0x25, 0x28, 0x2e, 0x34, 0x38, 0x3e, 0x44, 0x48, 0x4f, 0x53, 0x5a, 0x63, 0x72, 0x7d, 0x8b, 0x92, 0x9a,
    0xa5, 0x9a, 0x91, 0x86, 0x7b, 0x6d, 0x61, 0x5d, 0x52, 0x50, 0x49, 0x43, 0x40, 0x37, 0x32, 0x30, 0x28, 0x27, 0x1f, 0x21, 0x1e, 0x1b,
    0x17, 0x0f, 0x0c, 0x0b, 0x09, 0x08, 0x06, 0x04, 0x00, 0x00, 0x00, 0x00, 0x06, 0x05, 0x08, 0x0b, 0x09, 0x0d, 0x0e, 0x15, 0x19, 0x18,
    0x1d, 0x1d, 0x22, 0x25, 0x2b, 0x2f, 0x34, 0x39, 0x3c, 0x49, 0x4c, 0x51, 0x5b, 0x63, 0x70, 0x7b, 0x8c, 0x9b, 0xb0, 0xb6, 0xc1, 0xb4,
    0xa4, 0x93, 0x87, 0x79, 0x6b, 0x5f, 0x59, 0x54, 0x4e, 0x43, 0x40, 0x3b, 0x33, 0x31, 0x2c, 0x2b, 0x25, 0x1e, 0x1d, 0x19, 0x16, 0x0f,
    0x10, 0x0e, 0x08, 0x09, 0x08, 0x05, 0x00, 0x00, 0x00, 0x00, 0x05, 0x05, 0x08, 0x0a, 0x0c, 0x0d, 0x0f, 0x12, 0x18, 0x1b, 0x1f, 0x1f,
    0x23, 0x29, 0x2e, 0x30, 0x33, 0x3c, 0x3f, 0x49, 0x4d, 0x56, 0x5d, 0x65, 0x71, 0x88, 0x97, 0xb3, 0xc5, 0xd7, 0xdd, 0xcc, 0xbb, 0xa3,
    0x8d, 0x81, 0x70, 0x63, 0x56, 0x52, 0x50, 0x49, 0x44, 0x3a, 0x34, 0x32, 0x2c, 0x25, 0x21, 0x1d, 0x1d, 0x18, 0x18, 0x0e, 0x0c, 0x0b,
    0x09, 0x0a, 0x06, 0x05, 0x00, 0x00, 0x00, 0x00, 0x04, 0x05, 0x08, 0x08, 0x0a, 0x0b, 0x0d, 0x14, 0x16, 0x1c, 0x1e, 0x21, 0x25, 0x25,
    0x2b, 0x30, 0x33, 0x3b, 0x42, 0x4b, 0x50, 0x55, 0x5e, 0x6b, 0x79, 0x8d, 0xa7, 0xc0, 0xdc, 0xf5, 0xfa, 0xe7, 0xcc, 0xb1, 0x9b, 0x87,
    0x78, 0x6b, 0x5d, 0x53, 0x4b, 0x48, 0x3f, 0x3d, 0x32, 0x32, 0x2d, 0x29, 0x25, 0x1d, 0x1d, 0x1c, 0x16, 0x0f, 0x0f, 0x0d, 0x09, 0x0a,
    0x09, 0x06, 0x00, 0x00, 0x00, 0x00, 0x05, 0x08, 0x06, 0x08, 0x0b, 0x0e, 0x11, 0x12, 0x16, 0x1b, 0x1f, 0x24, 0x22, 0x2b, 0x2b, 0x2f,
    0x38, 0x3c, 0x42, 0x4c, 0x50, 0x57, 0x5c, 0x6b, 0x7f, 0x91, 0xaa, 0xc6, 0xe7, 0xff, 0xff, 0xf8, 0xd6, 0xb5, 0x9f, 0x8a, 0x78, 0x6d,
    0x5b, 0x55, 0x50, 0x46, 0x42, 0x3c, 0x32, 0x2e, 0x2c, 0x28, 0x25, 0x1e, 0x1b, 0x19, 0x14, 0x0f, 0x0d, 0x0d, 0x0a, 0x0a, 0x09, 0x05,
    0x00, 0x00, 0x00, 0x00, 0x06, 0x07, 0x08, 0x0a, 0x0a, 0x0b, 0x11, 0x12, 0x15, 0x19, 0x1d, 0x1e, 0x24, 0x29, 0x2e, 0x34, 0x34, 0x3a,
    0x44, 0x49, 0x51, 0x55, 0x5d, 0x67, 0x7d, 0x90, 0xa8, 0xc7, 0xe4, 0xfe, 0xff, 0xf2, 0xd5, 0xb2, 0xa1, 0x94, 0x87, 0x6f, 0x5c, 0x56,
    0x4f, 0x47, 0x3e, 0x3d, 0x34, 0x2f, 0x29, 0x29, 0x25, 0x22, 0x1c, 0x16, 0x16, 0x10, 0x0c, 0x0e, 0x0c, 0x07, 0x06, 0x06, 0x00, 0x00,
    0x00, 0x00, 0x06, 0x08, 0x0a, 0x0b, 0x0b, 0x0c, 0x0e, 0x16, 0x19, 0x1a, 0x1c, 0x1e, 0x27, 0x26, 0x2b, 0x30, 0x39, 0x3c, 0x43, 0x49,
    0x4e, 0x58, 0x5d, 0x6b, 0x7b, 0x8f, 0x9d, 0xb9, 0xce, 0xe5, 0xe8, 0xda, 0xc4, 0xab, 0x92, 0x87, 0x76, 0x66, 0x58, 0x55, 0x4c, 0x45,
    0x41, 0x3c, 0x32, 0x33, 0x2b, 0x29, 0x23, 0x1d, 0x1f, 0x19, 0x15, 0x12, 0x0f, 0x0c, 0x0c, 0x07, 0x09, 0x06, 0x00, 0x00, 0x00, 0x00,
    0x04, 0x06, 0x08, 0x08, 0x09, 0x0e, 0x11, 0x16, 0x16, 0x18, 0x1a, 0x1d, 0x25, 0x26, 0x29, 0x34, 0x3b, 0x3e, 0x3e, 0x46, 0x4b, 0x55,
    0x61, 0x66, 0x76, 0x86, 0x94, 0xa3, 0xb7, 0xc7, 0xc9, 0xbb, 0xac, 0x9f, 0x8b, 0x7e, 0x6d, 0x62, 0x57, 0x4f, 0x4c, 0x41, 0x40, 0x37,
    0x32, 0x32, 0x2e, 0x26, 0x21, 0x20, 0x1d, 0x1c, 0x19, 0x13, 0x0d, 0x0e, 0x0b, 0x09, 0x08, 0x06, 0x00, 0x00, 0x00, 0x00, 0x06, 0x07,
    0x09, 0x08, 0x0a, 0x0e, 0x10, 0x14, 0x15, 0x1b, 0x1f, 0x25, 0x28, 0x28, 0x28, 0x2e, 0x33, 0x3b, 0x43, 0x47, 0x4d, 0x51, 0x5a, 0x5e,
    0x6d, 0x79, 0x83, 0x94, 0x9f, 0xa9, 0xa9, 0xa3, 0x9b, 0x8d, 0x83, 0x73, 0x68, 0x5c, 0x53, 0x51, 0x48, 0x45, 0x3c, 0x39, 0x33, 0x2e,
    0x29, 0x24, 0x22, 0x1d, 0x19, 0x19, 0x18, 0x0f, 0x0c, 0x0e, 0x09, 0x08, 0x07, 0x06, 0x00, 0x00, 0x00, 0x00, 0x04, 0x05, 0x06, 0x0a,
    0x0a, 0x0d, 0x0f, 0x10, 0x16, 0x1a, 0x1d, 0x1c, 0x25, 0x28, 0x2a, 0x2f, 0x38, 0x3a, 0x3e, 0x43, 0x47, 0x4d, 0x54, 0x58, 0x62, 0x6b,
    0x78, 0x87, 0x8d, 0x99, 0x8f, 0x8c, 0x88, 0x83, 0x74, 0x6c, 0x61, 0x58, 0x55, 0x4b, 0x49, 0x43, 0x39, 0x33, 0x33, 0x30, 0x27, 0x23,
    0x23, 0x1e, 0x19, 0x16, 0x16, 0x12, 0x0d, 0x0d, 0x0c, 0x07, 0x05, 0x04, 0x00, 0x00, 0x00, 0x00, 0x04, 0x08, 0x07, 0x07, 0x08, 0x0c,
    0x0e, 0x11, 0x13, 0x19, 0x19, 0x1e, 0x24, 0x26, 0x29, 0x2a, 0x2e, 0x34, 0x3a, 0x3e, 0x46, 0x4e, 0x52, 0x55, 0x5e, 0x63, 0x6d, 0x76,
    0x7a, 0x90, 0x81, 0x7b, 0x7a, 0x74, 0x6c, 0x61, 0x5b, 0x56, 0x4c, 0x49, 0x42, 0x40, 0x3c, 0x37, 0x2f, 0x29, 0x26, 0x25, 0x20, 0x1c,
    0x1b, 0x19, 0x16, 0x12, 0x0f, 0x0b, 0x08, 0x07, 0x06, 0x05, 0x00, 0x00, 0x00, 0x00, 0x05, 0x07, 0x08, 0x09, 0x08, 0x0d, 0x0c, 0x12,
    0x16, 0x16, 0x19, 0x1d, 0x1d, 0x26, 0x29, 0x2a, 0x2e, 0x32, 0x36, 0x40, 0x41, 0x4b, 0x4f, 0x4f, 0x59, 0x5e, 0x66, 0x67, 0x70, 0x85,
    0x70, 0x70, 0x66, 0x66, 0x5e, 0x59, 0x53, 0x53, 0x4b, 0x46, 0x3f, 0x3a, 0x35, 0x34, 0x2e, 0x2e, 0x27, 0x24, 0x1d, 0x1a, 0x18, 0x16,
    0x0f, 0x11, 0x0d, 0x0c, 0x0b, 0x09, 0x07, 0x05, 0x00, 0x00, 0x00, 0x00, 0x05, 0x04, 0x07, 0x0a, 0x0b, 0x0b, 0x0b, 0x10, 0x11, 0x16,
    0x18, 0x1d, 0x21, 0x22, 0x26, 0x29, 0x2b, 0x30, 0x34, 0x39, 0x3d, 0x44, 0x4c, 0x4e, 0x51, 0x53, 0x59, 0x5d, 0x65, 0x74, 0x66, 0x5d,
    0x61, 0x5c, 0x58, 0x53, 0x4e, 0x4e, 0x48, 0x3f, 0x3d, 0x35, 0x35, 0x33, 0x2d, 0x2b, 0x23, 0x21, 0x21, 0x19, 0x18, 0x15, 0x11, 0x0c,
    0x0c, 0x0a, 0x0a, 0x06, 0x07, 0x04, 0x00, 0x00, 0x00, 0x00, 0x04, 0x05, 0x06, 0x06, 0x08, 0x09, 0x0d, 0x0f, 0x12, 0x14, 0x15, 0x1c,
    0x1d, 0x1f, 0x23, 0x28, 0x2b, 0x32, 0x30, 0x34, 0x3c, 0x40, 0x42, 0x49, 0x4d, 0x54, 0x50, 0x55, 0x55, 0x5e, 0x59, 0x59, 0x53, 0x56,
    0x53, 0x4e, 0x4d, 0x49, 0x3e, 0x3b, 0x37, 0x33, 0x32, 0x2e, 0x2d, 0x26, 0x25, 0x22, 0x1c, 0x19, 0x1a, 0x13, 0x11, 0x0d, 0x0d, 0x0a,
    0x08, 0x08, 0x05, 0x04, 0x00, 0x00, 0x00, 0x00, 0x03, 0x05, 0x07, 0x07, 0x07, 0x0b, 0x0a, 0x0e, 0x0d, 0x12, 0x16, 0x18, 0x1c, 0x20,
    0x22, 0x23, 0x28, 0x2e, 0x31, 0x34, 0x3a, 0x3a, 0x3c, 0x43, 0x47, 0x4c, 0x4c, 0x52, 0x4e, 0x50, 0x53, 0x4f, 0x4e, 0x4d, 0x4e, 0x4c,
    0x45, 0x40, 0x3e, 0x37, 0x38, 0x31, 0x31, 0x2e, 0x2b, 0x28, 0x21, 0x20, 0x19, 0x19, 0x16, 0x10, 0x0d, 0x0c, 0x0b, 0x09, 0x06, 0x07,
    0x06, 0x03, 0x00, 0x00, 0x00, 0x00, 0x02, 0x05, 0x04, 0x06, 0x06, 0x09, 0x0b, 0x0c, 0x0e, 0x12, 0x15, 0x18, 0x19, 0x1f, 0x23, 0x25,
    0x28, 0x29, 0x2a, 0x2f, 0x35, 0x34, 0x38, 0x3e, 0x3e, 0x45, 0x46, 0x4d, 0x4d, 0x49, 0x4f, 0x4c, 0x49, 0x46, 0x45, 0x43, 0x42, 0x3d,
    0x38, 0x35, 0x34, 0x2d, 0x2e, 0x28, 0x28, 0x24, 0x1e, 0x1b, 0x18, 0x18, 0x13, 0x11, 0x0e, 0x0a, 0x09, 0x09, 0x08, 0x05, 0x03, 0x04,
    0x00, 0x00, 0x00, 0x00, 0x02, 0x05, 0x05, 0x07, 0x09, 0x09, 0x0a, 0x0c, 0x0d, 0x11, 0x12, 0x15, 0x19, 0x1e, 0x1e, 0x21, 0x21, 0x29,
    0x27, 0x2f, 0x2e, 0x34, 0x37, 0x38, 0x38, 0x3a, 0x42, 0x3f, 0x46, 0x43, 0x47, 0x41, 0x40, 0x3e, 0x3e, 0x3c, 0x3d, 0x35, 0x32, 0x32,
    0x2c, 0x2b, 0x2b, 0x26, 0x20, 0x21, 0x1b, 0x1d, 0x1b, 0x15, 0x12, 0x10, 0x0b, 0x0c, 0x09, 0x07, 0x07, 0x06, 0x05, 0x04, 0x00, 0x00,
    0x00, 0x00, 0x02, 0x03, 0x04, 0x07, 0x07, 0x07, 0x0b, 0x0c, 0x0a, 0x0f, 0x0e, 0x16, 0x15, 0x1b, 0x1c, 0x21, 0x20, 0x23, 0x29, 0x27,
    0x2e, 0x32, 0x32, 0x37, 0x36, 0x38, 0x3b, 0x3a, 0x46, 0x3c, 0x42, 0x3f, 0x3a, 0x3d, 0x3a, 0x36, 0x34, 0x37, 0x30, 0x31, 0x2e, 0x2b,
    0x26, 0x21, 0x21, 0x1f, 0x19, 0x1b, 0x18, 0x15, 0x0e, 0x0d, 0x0d, 0x0a, 0x09, 0x09, 0x07, 0x05, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
    0x03, 0x02, 0x03, 0x05, 0x07, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x10, 0x0f, 0x18, 0x16, 0x1c, 0x1d, 0x1f, 0x21, 0x24, 0x26, 0x2a, 0x2e,
    0x2e, 0x32, 0x32, 0x31, 0x39, 0x34, 0x3c, 0x34, 0x3c, 0x36, 0x35, 0x34, 0x34, 0x34, 0x32, 0x30, 0x2f, 0x29, 0x28, 0x25, 0x23, 0x21,
    0x20, 0x1d, 0x18, 0x16, 0x13, 0x11, 0x0e, 0x0b, 0x0b, 0x0b, 0x08, 0x08, 0x04, 0x04, 0x03, 0x02, 0x00, 0x00, 0x00, 0x00, 0x02, 0x02,
    0x03, 0x04, 0x05, 0x05, 0x07, 0x08, 0x0a, 0x0a, 0x0c, 0x11, 0x15, 0x16, 0x19, 0x1c, 0x1d, 0x21, 0x22, 0x25, 0x28, 0x29, 0x28, 0x2a,
    0x2b, 0x30, 0x34, 0x30, 0x36, 0x34, 0x35, 0x30, 0x34, 0x30, 0x30, 0x31, 0x2e, 0x2b, 0x2c, 0x29, 0x22, 0x21, 0x1e, 0x1c, 0x1a, 0x1c,
    0x15, 0x18, 0x0f, 0x10, 0x0b, 0x0b, 0x0a, 0x07, 0x07, 0x07, 0x04, 0x05, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x02, 0x02, 0x02, 0x05,
    0x04, 0x04, 0x08, 0x09, 0x0a, 0x0c, 0x0e, 0x0d, 0x0d, 0x13, 0x18, 0x16, 0x1c, 0x1a, 0x1e, 0x1d, 0x20, 0x22, 0x25, 0x2a, 0x2d, 0x28,
    0x2b, 0x2f, 0x2f, 0x2d, 0x33, 0x2b, 0x2d, 0x30, 0x2e, 0x2e, 0x28, 0x26, 0x28, 0x25, 0x23, 0x20, 0x1e, 0x19, 0x1b, 0x18, 0x16, 0x12,
    0x0e, 0x0f, 0x0a, 0x0b, 0x07, 0x09, 0x05, 0x04, 0x06, 0x02, 0x04, 0x01, 0x00, 0x00, 0x00, 0x00, 0x02, 0x02, 0x02, 0x03, 0x04, 0x04,
    0x06, 0x06, 0x09, 0x0c, 0x0d, 0x0b, 0x0d, 0x0d, 0x13, 0x15, 0x15, 0x1c, 0x1c, 0x1f, 0x21, 0x20, 0x25, 0x23, 0x28, 0x27, 0x29, 0x28,
    0x27, 0x2d, 0x2f, 0x28, 0x2c, 0x29, 0x2a, 0x28, 0x27, 0x25, 0x23, 0x21, 0x1f, 0x1d, 0x1c, 0x19, 0x16, 0x14, 0x12, 0x11, 0x0e, 0x0e,
    0x0a, 0x0b, 0x08, 0x08, 0x06, 0x05, 0x05, 0x02, 0x03, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x02, 0x04, 0x04, 0x04, 0x06,
    0x08, 0x0a, 0x09, 0x0c, 0x0b, 0x10, 0x0d, 0x12, 0x16, 0x15, 0x1b, 0x1c, 0x1c, 0x20, 0x1f, 0x21, 0x24, 0x25, 0x22, 0x22, 0x29, 0x26,
    0x27, 0x25, 0x22, 0x22, 0x26, 0x23, 0x20, 0x22, 0x1d, 0x20, 0x1d, 0x1b, 0x19, 0x16, 0x16, 0x12, 0x11, 0x0e, 0x0c, 0x0c, 0x09, 0x08,
    0x06, 0x06, 0x05, 0x04, 0x04, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x01, 0x04, 0x03, 0x05, 0x05, 0x07, 0x06, 0x06,
    0x07, 0x0b, 0x0b, 0x0c, 0x0e, 0x0d, 0x12, 0x13, 0x16, 0x1a, 0x1a, 0x1c, 0x1f, 0x1e, 0x21, 0x22, 0x1e, 0x23, 0x20, 0x25, 0x22, 0x22,
    0x21, 0x21, 0x20, 0x1d, 0x21, 0x1c, 0x1f, 0x1c, 0x1a, 0x18, 0x19, 0x14, 0x0e, 0x0f, 0x0d, 0x0c, 0x0a, 0x0a, 0x07, 0x09, 0x06, 0x06,
    0x05, 0x03, 0x03, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x05, 0x04, 0x07, 0x08, 0x09, 0x09,
    0x08, 0x0c, 0x0b, 0x0d, 0x0d, 0x0e, 0x13, 0x13, 0x19, 0x16, 0x18, 0x1a, 0x1d, 0x1f, 0x1c, 0x1f, 0x1d, 0x21, 0x20, 0x1c, 0x20, 0x1c,
    0x1c, 0x1f, 0x1a, 0x1d, 0x1a, 0x16, 0x14, 0x14, 0x13, 0x0f, 0x0d, 0x0d, 0x0d, 0x0b, 0x0b, 0x09, 0x07, 0x07, 0x05, 0x03, 0x05, 0x02,
    0x03, 0x02, 0x01, 0x02, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x02, 0x02, 0x03, 0x03, 0x06, 0x07, 0x06, 0x09, 0x08, 0x09,
    0x0c, 0x0b, 0x0e, 0x0d, 0x0d, 0x12, 0x16, 0x16, 0x16, 0x16, 0x16, 0x1c, 0x1c, 0x19, 0x1b, 0x1d, 0x1d, 0x1b, 0x1a, 0x19, 0x1c, 0x1a,
    0x1a, 0x18, 0x18, 0x15, 0x10, 0x10, 0x0f, 0x0d, 0x0c, 0x0a, 0x0b, 0x0a, 0x09, 0x07, 0x07, 0x05, 0x05, 0x05, 0x03, 0x03, 0x02, 0x01,
    0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x01, 0x02, 0x04, 0x04, 0x03, 0x06, 0x06, 0x06, 0x08, 0x08, 0x0a, 0x0b,
    0x0a, 0x0b, 0x0c, 0x11, 0x11, 0x12, 0x14, 0x15, 0x19, 0x19, 0x14, 0x16, 0x19, 0x18, 0x19, 0x1a, 0x15, 0x19, 0x16, 0x14, 0x15, 0x16,
    0x12, 0x0f, 0x11, 0x10, 0x0f, 0x0d, 0x0c, 0x09, 0x0b, 0x08, 0x09, 0x05, 0x04, 0x05, 0x05, 0x03, 0x02, 0x02, 0x02, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x02, 0x01, 0x03, 0x03, 0x02, 0x04, 0x06, 0x06, 0x05, 0x08, 0x09, 0x0b, 0x09, 0x0a,
    0x0c, 0x0b, 0x0d, 0x0d, 0x0d, 0x10, 0x10, 0x0f, 0x12, 0x13, 0x16, 0x15, 0x16, 0x13, 0x18, 0x12, 0x12, 0x11, 0x0e, 0x10, 0x0d, 0x10,
    0x0e, 0x0d, 0x0a, 0x0a, 0x0a, 0x08, 0x08, 0x08, 0x08, 0x06, 0x06, 0x04, 0x02, 0x01, 0x03, 0x02, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x02, 0x01, 0x02, 0x02, 0x02, 0x03, 0x04, 0x05, 0x06, 0x06, 0x06, 0x07, 0x09, 0x08, 0x0b,
    0x0a, 0x0d, 0x0c, 0x0e, 0x0e, 0x10, 0x0f, 0x0f, 0x0e, 0x10, 0x12, 0x0e, 0x0f, 0x10, 0x0e, 0x0d, 0x0f, 0x0f, 0x0d, 0x0c, 0x0a, 0x0b,
    0x08, 0x09, 0x09, 0x06, 0x07, 0x05, 0x05, 0x04, 0x05, 0x04, 0x01, 0x02, 0x02, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x04, 0x04, 0x04, 0x05, 0x04, 0x07, 0x07, 0x09, 0x08, 0x08, 0x08, 0x0b, 0x09,
    0x0c, 0x0d, 0x0b, 0x0c, 0x0b, 0x0e, 0x0b, 0x0c, 0x0d, 0x0f, 0x0b, 0x0b, 0x0b, 0x0c, 0x0b, 0x0a, 0x0b, 0x0c, 0x09, 0x08, 0x08, 0x0a,
    0x06, 0x08, 0x05, 0x04, 0x05, 0x03, 0x02, 0x03, 0x03, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x01, 0x01, 0x03, 0x03, 0x03, 0x04, 0x06, 0x07, 0x05, 0x08, 0x08, 0x07, 0x0a, 0x07, 0x08, 0x0a,
    0x0c, 0x0a, 0x0a, 0x09, 0x0b, 0x0d, 0x0b, 0x0d, 0x0a, 0x0d, 0x0b, 0x0a, 0x0c, 0x0b, 0x08, 0x0a, 0x08, 0x07, 0x07, 0x08, 0x05, 0x07,
    0x04, 0x04, 0x03, 0x04, 0x01, 0x01, 0x02, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x03, 0x04, 0x04, 0x05, 0x05, 0x05, 0x04, 0x08, 0x07, 0x06, 0x08, 0x0a, 0x0a, 0x09,
    0x09, 0x08, 0x0b, 0x09, 0x0c, 0x09, 0x08, 0x08, 0x08, 0x08, 0x09, 0x0a, 0x07, 0x07, 0x08, 0x07, 0x06, 0x05, 0x04, 0x03, 0x02, 0x04,
    0x02, 0x03, 0x01, 0x02, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x01, 0x02, 0x03, 0x02, 0x03, 0x05, 0x04, 0x06, 0x06, 0x05, 0x05, 0x07, 0x07, 0x06, 0x09, 0x06, 0x07, 0x0a,
    0x0a, 0x07, 0x0a, 0x07, 0x08, 0x07, 0x07, 0x08, 0x07, 0x06, 0x06, 0x05, 0x06, 0x05, 0x05, 0x06, 0x04, 0x02, 0x03, 0x02, 0x03, 0x02,
    0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x02, 0x01, 0x01, 0x02, 0x03, 0x03, 0x03, 0x03, 0x06, 0x03, 0x04, 0x06, 0x07, 0x06, 0x07, 0x05, 0x08, 0x07, 0x08,
    0x06, 0x08, 0x08, 0x06, 0x07, 0x05, 0x05, 0x04, 0x06, 0x04, 0x04, 0x05, 0x05, 0x04, 0x03, 0x03, 0x03, 0x01, 0x02, 0x01, 0x01, 0x01,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x01, 0x00, 0x01, 0x02, 0x02, 0x02, 0x02, 0x04, 0x02, 0x04, 0x05, 0x04, 0x04, 0x05, 0x05, 0x06, 0x06, 0x06, 0x05, 0x06, 0x05,
    0x05, 0x05, 0x05, 0x04, 0x05, 0x03, 0x04, 0x05, 0x04, 0x03, 0x04, 0x02, 0x02, 0x02, 0x02, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00,
};

float random(float x) {
  return glm::linearRand(0.0f, x);
}

const int kMaxParticles = 50000;
const int kStackSize = 50000;

vec3 g_Gravity = {0, -0.001, 0};
bool g_Pause = false;

enum ParticleStateMessage {
  PSM_None = 0,
  PSM_Kill = 1,
  PSM_Emission = 2,
};

struct Particle {
  vec3 pos = vec3(0.0f);
  vec3 velocity = vec3(0.0f);
  vec3 baseColor = vec3(0.0f);
  vec3 currentColor = vec3(0.0f);

  // lifetime tracking
  int TTL = 0;
  int initialLT = 1;

  // state flags
  bool alive = false;
  bool flare = false;
  bool spawnExplosion = false;

  // visual properties
  bool fadingOut = false;
  bool emission = false;

  Particle() = default;

  Particle(vec3 pos, vec3 vel, vec3 color, int ttl, bool fadingOut = false)
  : pos(pos)
  , velocity(vel)
  , baseColor(color)
  , currentColor(color)
  , TTL(ttl)
  , initialLT(ttl)
  , alive(true)
  , fadingOut(fadingOut) {}

  ParticleStateMessage update() {
    pos += velocity;
    velocity += g_Gravity;
    TTL--;

    if (fadingOut) {
      const float t = static_cast<float>(TTL) / initialLT;
      currentColor = baseColor * t;
    }

    if (TTL < 0)
      return PSM_Kill;

    return emission ? PSM_Emission : PSM_None;
  }
};

struct ParticleSystem {
  Particle particles[kMaxParticles];
  Particle particlesStack[kStackSize];
  int totalParticles = 0;
  int queuedParticles = 0;

  void nextFrame() {
    int processedParticles = 0;

    for (int i = 0; i < kMaxParticles; i++) {
      if (particles[i].alive) {
        processedParticles++;

        switch (particles[i].update()) {
        case PSM_None:
          break;
        case PSM_Kill:
          if (particles[i].spawnExplosion)
            addExplosion(particles[i].pos);
          particles[i].alive = false;
          totalParticles--;
          break;
        case PSM_Emission:
          addParticle(Particle(particles[i].pos,
                               particles[i].velocity * (random(10) / 10.0f),
                               particles[i].currentColor * 0.9f,
                               particles[i].TTL >> 2,
                               true));
          break;
        }
      } else if (queuedParticles > 0) {
        particles[i] = particlesStack[--queuedParticles];
        totalParticles++;
      } else if (processedParticles >= totalParticles) {
        return;
      }
    }
  }

  void addParticle(const Particle& particle) {
    if (queuedParticles < kStackSize)
      particlesStack[queuedParticles++] = particle;
  }
  void addExplosion(vec3 pos) {
    const vec3 FlarePal[3] = {
        {0.2, 0.30, 0.8},
        {0.7, 0.25, 0.3},
        {0.1, 0.80, 0.2},
    };

    const int paletteIndex = static_cast<int>(random(3));

    for (int i = 0; i < 300; i++) {
      float radius = random(1) / 10;
      float angle = random(M_PI * 2.0f);
      vec3 velocity(radius * cosf(angle), radius * sinf(angle), (random(100) - 50) / 5000.0f);
      vec3 color = FlarePal[paletteIndex] + vec3(random(1) / 5, random(1) / 5, random(1) / 5);

      Particle particle(pos, velocity, color, 90 + random(20), true);
      particle.emission = true;

      addParticle(particle);
    }
  }
};

ParticleSystem g_Points;

struct Vertex {
  vec3 pos;
  vec4 color;
};

struct PerFrame {
  mat4 proj;
  mat4 view;
  uint32_t texture;
};

VULKAN_APP_MAIN {
  VkPhysicalDeviceMeshShaderFeaturesEXT meshShaderFeatures = {
      .sType = VK_STRUCTURE_TYPE_PHYSICAL_DEVICE_MESH_SHADER_FEATURES_EXT,
      .taskShader = VK_TRUE,
      .meshShader = VK_TRUE,
  };
  const VulkanAppConfig cfg{
      .width = -90,
      .height = -90,
      .resizable = true,
      .contextConfig =
          {
              .extensionsDevice = {"VK_EXT_mesh_shader"},
              .extensionsDeviceFeatures = &meshShaderFeatures,
          },
  };
  VULKAN_APP_DECLARE(app, cfg);

  lvk::IContext* ctx = app.ctx_.get();

  lvk::Holder<lvk::BufferHandle> vb0_[3];
  for (auto& vb : vb0_) {
    vb = ctx->createBuffer({
        .usage = lvk::BufferUsageBits_Storage,
        .storage = lvk::StorageType_Device,
        .size = sizeof(Vertex) * kMaxParticles,
        .debugName = "Buffer: vertices",
    });
  }

  lvk::Holder<lvk::BufferHandle> bufPerFrame = ctx->createBuffer({
      .usage = lvk::BufferUsageBits_Storage,
      .storage = lvk::StorageType_HostVisible,
      .size = sizeof(PerFrame),
      .debugName = "Buffer: per frame",
  });

  lvk::Holder<lvk::SamplerHandle> sampler_ = ctx->createSampler({.debugName = "Sampler: linear"}, nullptr);

  lvk::Holder<lvk::TextureHandle> texture_ = ctx->createTexture({
      .type = lvk::TextureType_2D,
      .format = lvk::Format_R_UN8,
      .dimensions = {64, 64},
      .usage = lvk::TextureUsageBits_Sampled,
      .data = g_Image,
      .debugName = "Particle",
  });

#if defined(LVK_DEMO_WITH_SLANG)
  lvk::Holder<lvk::ShaderModuleHandle> mesh_ = ctx->createShaderModule({codeSlang, lvk::Stage_Mesh, "Shader Module: main (mesh)"});
  lvk::Holder<lvk::ShaderModuleHandle> frag_ = ctx->createShaderModule({codeSlang, lvk::Stage_Frag, "Shader Module: main (frag)"});
#else
  lvk::Holder<lvk::ShaderModuleHandle> mesh_ = ctx->createShaderModule({codeMesh, lvk::Stage_Mesh, "Shader Module: main (mesh)"});
  lvk::Holder<lvk::ShaderModuleHandle> frag_ = ctx->createShaderModule({codeFS, lvk::Stage_Frag, "Shader Module: main (frag)"});
#endif // defined(LVK_DEMO_WITH_SLANG)

  lvk::Holder<lvk::RenderPipelineHandle> renderPipelineState_Mesh_ = ctx->createRenderPipeline({
      .smMesh = mesh_,
      .smFrag = frag_,
      .color = {{
          .format = ctx->getSwapchainFormat(),
          .blendEnabled = true,
          .rgbBlendOp = lvk::BlendOp_Add,
          .alphaBlendOp = lvk::BlendOp_Add,
          .srcRGBBlendFactor = lvk::BlendFactor_SrcAlpha,
          .srcAlphaBlendFactor = lvk::BlendFactor_SrcAlpha,
          .dstRGBBlendFactor = lvk::BlendFactor_One,
          .dstAlphaBlendFactor = lvk::BlendFactor_One,
      }},
      .cullMode = lvk::CullMode_None,
      .debugName = "Pipeline: mesh",
  });

#if !defined(ANDROID)
  app.addKeyCallback([](GLFWwindow* window, int key, int, int action, int) {
    if (key == GLFW_KEY_1 && action == GLFW_PRESS) {
      g_Gravity.x += 0.001f;
    }
    if (key == GLFW_KEY_2 && action == GLFW_PRESS) {
      g_Gravity.x -= 0.001f;
    }
    if (key == GLFW_KEY_SPACE && action == GLFW_PRESS) {
      g_Pause = !g_Pause;
    }
  });
#endif // !ANDROID

  std::vector<Vertex> vertices;
  vertices.reserve(kMaxParticles);

  const float kTimeQuantum = 0.02f;
  double accTime = 0;
  uint32_t bufferIndex = 0;

  app.run([&](uint32_t width, uint32_t height, float aspectRatio, float deltaSeconds) {
    LVK_PROFILER_FUNCTION();

    if (!g_Pause)
      accTime += deltaSeconds;

    if (accTime >= kTimeQuantum) {
      accTime -= kTimeQuantum;
      g_Points.nextFrame();
      if (random(50) <= 1) {
        // shoot a new firework
        const vec3 position((random(100) - 50) / 10, -5, 0);
        const vec3 velocity((random(100) - 50) / 500.0f, 0.25f + (random(200)) / 500.0f, (random(100) - 50) / 500.0f);
        const vec3 color(0.5f, 0.8f, 0.9f);
        Particle flare(position, velocity, color, 20);
        flare.flare = true;
        flare.spawnExplosion = true;
        g_Points.addParticle(flare);
      }
      vertices.clear();
      for (int i = 0; i != kMaxParticles; i++) {
        if (g_Points.particles[i].alive) {
          const Particle& p = g_Points.particles[i];
          vertices.push_back(Vertex{
              .pos = p.pos,
              .color = vec4(p.currentColor, p.flare ? 1.0f : 0.0f),
          });
        }
      }
      if (!vertices.empty()) {
        bufferIndex = (bufferIndex + 1) % LVK_ARRAY_NUM_ELEMENTS(vb0_);
        ctx->upload(vb0_[bufferIndex], vertices.data(), sizeof(Vertex) * vertices.size());
      }
    }

    const PerFrame perFrame = {
        .proj = glm::perspective(glm::radians(90.0f), aspectRatio, 0.1f, 100.0f),
        .view = glm::translate(mat4(1.0f), vec3(0.0f, 0.0f, -8.0f)),
        .texture = texture_.index(),
    };

    lvk::ICommandBuffer& buffer = ctx->acquireCommandBuffer();

    buffer.cmdUpdateBuffer(bufPerFrame, perFrame);

    const lvk::Framebuffer framebuffer = {
        .color = {{.texture = ctx->getCurrentSwapchainTexture()}},
    };
    buffer.cmdBeginRendering(
        lvk::RenderPass{
            .color = {{.loadOp = lvk::LoadOp_Clear, .storeOp = lvk::StoreOp_Store, .clearColor = {0.0f, 0.0f, 0.0f, 0.0f}}},
        },
        framebuffer);
    {
      buffer.cmdBindRenderPipeline(renderPipelineState_Mesh_);
      buffer.cmdBindViewport({0.0f, 0.0f, (float)width, (float)height, 0.0f, +1.0f});
      buffer.cmdBindScissorRect({0, 0, (uint32_t)width, (uint32_t)height});
      buffer.cmdPushDebugGroupLabel("Render Mesh", 0xff0000ff);
      buffer.cmdBindDepthState({.compareOp = lvk::CompareOp_AlwaysPass, .isDepthWriteEnabled = false});
      const struct {
        uint64_t perFrame;
        uint64_t vb;
      } bindings = {
          .perFrame = ctx->gpuAddress(bufPerFrame),
          .vb = ctx->gpuAddress(vb0_[bufferIndex]),
      };
      buffer.cmdPushConstants(bindings);
      if (!vertices.empty()) {
        buffer.cmdDrawMeshTasks({(uint32_t)vertices.size(), 1, 1});
      }
      buffer.cmdPopDebugGroupLabel();
    }
    app.imgui_->beginFrame(framebuffer);
    ImGui::SetNextWindowPos({0, 0});
    ImGui::Begin("Info", nullptr, ImGuiWindowFlags_AlwaysAutoResize);
    ImGui::Text("Particles: %i", g_Points.totalParticles);
    ImGui::End();
    app.drawFPS();
    app.imgui_->endFrame(buffer);
    buffer.cmdEndRendering();

    ctx->submit(buffer, ctx->getCurrentSwapchainTexture());
  });

  VULKAN_APP_EXIT();
}
